generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User{
  id                String              @id              @default(uuid())
  createdAt         DateTime            @default(now())  @map("created_at")
  updatedAt         DateTime            @updatedAt       @map("updated_at")

  isAdmin           Boolean                              @map("is_admin")
  isSuperAdmin      Boolean              @default(false)  @map("is_super_admin")

  email             String              @unique
  name              String?
  position          String?                             @map("position")
  avatar            String?                             @map("avatar")

  password          String

  createdDictionaries   Dictionary[]    @relation("CreatedDictionaries")
  updatedDictionaries   Dictionary[]    @relation("UpdatedDictionaries")
  nodeHistory           NodeHistory[]

  @@map("user")
}

model Node {
  id                    String          @id @default(cuid())
  type                  NodeType      
  position              Json      

  data                  NodeData?       @relation("NodeToNodeData")
  nodeDataId            String?         @unique

  measured              Json?

  parent                Node?           @relation("NestedNode", fields: [parentId], references: [id], onDelete: Cascade)
  parentId              String?     
  children              Node[]          @relation("NestedNode")

  pathAreaId            String?         @map("path_area_id")
  pathArea              PathArea?       @relation(fields: [pathAreaId], references: [id], onDelete: SetNull)

  @@index([pathAreaId])
}

model NodeData {
  id                    String          @id @default(uuid())
  label                 String
  handlers              Json

  locked                Boolean?        @default(false)
  visualState           Json?

  node                  Node            @relation("NodeToNodeData", fields: [nodeId], references: [id], onDelete: Cascade)
  nodeId                String          @unique

  tableData             TableData[]
}

model TableData {
  id                    String          @id @default(uuid())
  protectionName        String
  excerpt               String
  source                String
  triggeringAlgorithm   String
  triggeringConditions  String

  nodeData              NodeData?       @relation(fields: [nodeDataId], references: [id], onDelete: Cascade)
  nodeDataId            String?    

  order Int 
}

model Edge {
  id                    String          @id               @default(cuid())
  source                String
  target                String
  sourceHandle          String
  targetHandle          String
  type                  String
  style                 Json
}

model Dictionary {
  id                    String          @id               @default(uuid())
  short                 String          @unique           @map("short")
  full                  String                            @map("full")
  
  createdAt             DateTime        @default(now())   @map("created_at")
  updatedAt             DateTime        @updatedAt        @map("updated_at")

  createdBy             User?           @relation("CreatedDictionaries", fields: [createdById], references: [id], onDelete: SetNull)
  createdById           String?         @map("created_by_id")
  
  updatedBy             User?           @relation("UpdatedDictionaries", fields: [updatedById], references: [id], onDelete: SetNull)
  updatedById           String?         @map("updated_by_id")

  @@map("dictionary")
}

model NodeHistory {
  id          String      @id @default(uuid())
  createdAt   DateTime    @default(now()) @map("created_at")
  userId      String      @map("user_id")
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  entityType  EntityType  @map("entity_type")
  entityId    String      @map("entity_id")
  actionType  ActionType  @map("action_type")
  changes     Json        
  description String?     @map("description")

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("node_history")
}

model Country {
  id          String      @id @default(uuid())
  name        String
  code        String?     @unique
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  pathAreas   PathArea[]

  @@map("country")
}

model PathArea {
  id          String      @id @default(uuid())
  name        String
  countryId   String      @map("country_id")
  country     Country     @relation(fields: [countryId], references: [id], onDelete: Cascade)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  nodes       Node[]

  @@index([countryId])
  @@map("path_area")
}


enum NodeType {
  OPS
  TankPark
  Checkpoint
  Valve
  Pump
  ChildTankPark
  AccountingSystem
  Factory
  Object
  ParentObject
  ChildObject
  PNS
  MNS
  SAR
  FGU
  KPPSOD
  Capacity
  River
}

enum EntityType {
  NODE
  EDGE
  TABLE_DATA
}

enum ActionType {
  CREATE
  UPDATE
  DELETE
  MOVE
  LOCK
  UNLOCK
  VISUAL_STATE_CHANGE
  PARENT_CHANGE
  HANDLERS_CHANGE
  LABEL_CHANGE
  TYPE_CHANGE
  AREA_CHANGE
}